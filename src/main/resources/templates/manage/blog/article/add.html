<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
	<th:block th:include="manage/include :: header('文章撰写')" />
    <th:block th:include="manage/include :: summernote-css" />
    <th:block th:include="manage/include :: select2-css" />
    <th:block th:include="manage/include :: bootstrap-select-css" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-article-add" name="form-article-add">
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label is-required">文章标题：</label>
                        <div class="col-sm-9">
                            <input id="title" name="title" placeholder="请输入标题" autocomplete="false" class="form-control" type="text" maxlength="30" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label is-required">文章分类：</label>
                        <div class="col-sm-6">
                            <select id="category" name="category" class="form-control m-b" th:with="categories=${@articleEdit.getCategories()}">
                                <option value="">请选择</option>
                                <option th:each="category : ${categories}" th:text="${category.name}" th:value="${category.id}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label is-required">文章标签：</label>
                        <div class="col-sm-7">
                            <select id="tagIds" name="tagIds" class="form-control m-b select2-multiple" th:with="tags=${@articleEdit.getArtTags()}" multiple>
                                <option th:each="tag : ${tags}" th:text="${tag.name}" th:value="${tag.id}"></option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-xs-2 control-label">文章内容：</label>
                        <div class="col-xs-10">
                            <input id="content" name="content" type="hidden" />
                            <input id="state" name="state" type="hidden" />
                            <div class="ibox-content no-padding">
                                <div id="articlenote" class="summernote">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-offset-5 col-sm-10">
                    <button type="button" class="btn btn-sm btn-warning" onclick="submitHandler('0')"><i class="fa fa-check"></i>存入草稿</button>&nbsp;
                    <button type="button" class="btn btn-sm btn-primary" onclick="submitHandler('1')"><i class="fa fa-upload"></i>发布文章 </button>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="manage/include :: footer" />
    <th:block th:include="manage/include :: summernote-js" />
    <th:block th:include="manage/include :: select2-js" />
    <th:block th:include="manage/include :: bootstrap-select-js" />
    <script type="text/javascript">
	    var prefix = ctx + "manage/article";

        $(document).ready(function () {
            $('#articlenote').summernote({
                lang: 'zh-CN',
                height: 450,
                callbacks:{
                    onImageUpload: function (files) {
                        //上传图片到服务器
                        var formData = new FormData();
                        formData.append('editormd-image-file', files[0]);
                        $.ajax({
                            url : '/uploadfile/imgUpload',//后台文件上传接口
                            type : 'POST',
                            data : formData,
                            processData : false,
                            contentType : false,
                            dataType : "json",
                            success : function(resp) {
                                $('#articlenote').summernote('insertImage', resp.url);
                            },error:function(resp){
                                $.modal.alert("文件上传失败！msg: " + resp.message);
                            }
                        });
                    }
                }

            });
        });
	
	    $("#form-article-add").validate({
	    	onkeyup: false,
            ignore: "",
	        rules: {
	            title: {
	                remote: {
	                    url: prefix + "/checkArticleUnique",
	                    type: "post",
	                    dataType: "json",
	                    data: {
	                        "name": function() {
	                            return $.common.trim($("#title").val());
	                        }
	                    },
	                    dataFilter: function(data, type) {
	                        return $.validate.unique(data);
	                    }
	                }
	            },
                category: {
	                required: true
                },
                tagIds: {
	                required: true
                },
	        },
	        messages: {
	            "title": {
	                remote: "文章标题已经存在"
	            }
	        },
	        focusCleanup: true
	    });
	    
	    function submitHandler(state) {
	        if ($.validate.form()) {
	            $("#content").val($('#articlenote').summernote('code'));
	            $("#state").val(state);
	            $.operate.saveTab(prefix + "/add", $('#form-article-add').serialize());
	        }
	    }
    </script>
</body>
</html>
